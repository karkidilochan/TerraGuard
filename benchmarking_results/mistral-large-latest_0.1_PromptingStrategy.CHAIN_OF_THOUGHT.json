[
    {
        "Prompt ID": 1,
        "Resource": "aws_cloudwatch_log_group, aws_cloudwatch_log_resource_policy, aws_route53_query_log, aws_route53_zone, aws_iam_policy_document",
        "Prompt": "Configure a query log that can create a log stream and put log events using Route 53 resources. Name the zone \"primary\", the cloudwatch log group \"aws_route53_example_com\", and the cloudwatch log resource policy \"route53-query-logging-policy\"",
        "Rego Intent": "package terraform.validation\n\ndefault is_configuration_valid = false\n\ndefault is_valid_r53_zone = false\n\ndefault is_valid_cloudwatch_log_group = false\n\ndefault is_valid_cloudwatch_log_resource_policy = false\n\ndefault is_valid_route53_query_log = false\n\n# Validate aws_route53_zone resource\nis_valid_r53_zone {\n    some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_zone\"\n    resource.expressions.name\n}\n\nis_valid_cloudwatch_log_group {\n    some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_cloudwatch_log_group\"\n}\n\nis_valid_cloudwatch_log_resource_policy {\n    some i\n    resource := input.resource_changes[i]\n    resource.type == \"aws_cloudwatch_log_resource_policy\"\n    contains(resource.change.after.policy_document, \"logs:PutLogEvents\")\n    contains(resource.change.after.policy_document, \"logs:CreateLogStream\")\n    resource.change.after.policy_name\n}\n\nis_valid_route53_query_log {\n    some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_query_log\"\n    resource.expressions.zone_id.references[0] == \"aws_route53_zone.primary.zone_id\"\n    resource.expressions.cloudwatch_log_group_arn.references[0] == \"aws_cloudwatch_log_group.aws_route53_example_com.arn\"\n    resource.depends_on[0] == \"aws_cloudwatch_log_resource_policy.route53-query-logging-policy\"\n}\n\n# Combine all checks into a final rule\nis_configuration_valid {\n    is_valid_r53_zone\n    is_valid_cloudwatch_log_group\n    is_valid_cloudwatch_log_resource_policy\n    is_valid_route53_query_log\n}",
        "Difficulty": 5,
        "Reference Output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\n\nresource \"aws_route53_zone\" \"primary\" {\n  name = \"example53.com\"\n}\n\nresource \"aws_cloudwatch_log_group\" \"aws_route53_example_com\" {\n  name              = \"/aws/route53/${aws_route53_zone.primary.name}\"\n  retention_in_days = 30\n}\n\n# Example CloudWatch log resource policy to allow Route53 to write logs\n# to any log group under /aws/route53/*\n\ndata \"aws_iam_policy_document\" \"route53-query-logging-policy\" {\n  statement {\n    actions = [\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\",\n    ]\n\n    resources = [\"arn:aws:logs:*:*:log-group:/aws/route53/*\"]\n\n    principals {\n      identifiers = [\"route53.amazonaws.com\"]\n      type        = \"Service\"\n    }\n  }\n}\n\nresource \"aws_cloudwatch_log_resource_policy\" \"route53-query-logging-policy\" {\n  policy_document = data.aws_iam_policy_document.route53-query-logging-policy.json\n  policy_name     = \"route53-query-logging-policy\"\n}\n\nresource \"aws_route53_query_log\" \"example_com\" {\n  depends_on = [aws_cloudwatch_log_resource_policy.route53-query-logging-policy]\n\n  cloudwatch_log_group_arn = aws_cloudwatch_log_group.aws_route53_example_com.arn\n  zone_id                  = aws_route53_zone.primary.zone_id\n}",
        "Intent": "Has one \"aws_route53_zone\" resource\n    with \"name\"\n\nHas one \"aws_cloudwatch_log_group\" resource\n\nHas one \"aws_cloudwatch_log_resource_policy\" resource\n    with \"policy_document\" enabling \"logs:CreateLogStream\" and \"logs:PutLogEvents\"\n    with \"policy_name\"\n\nHas one \"aws_route53_query_log\" resource\n    with \"cloudwatch_log_group_arn\" referencing the \"aws_cloudwatch_log_group\" resource\n    with \"zone_id\" referencing the \"aws_route53_zone\" resource\n    and depends on the \"aws_cloudwatch_log_resource_policy\" resource",
        "Generated Code": "```hcl\nprovider \"aws\" {\n  region = \"us-west-2\"\n}\n\ndata \"aws_region\" \"current\" {}\ndata \"aws_caller_identity\" \"current\" {}\n\nresource \"aws_iam_role\" \"route53_logging_role\" {\n  name = \"route53-query-logging-role\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Action = \"sts:AssumeRole\"\n      Effect = \"Allow\"\n      Principal = {\n        Service = \"route53.amazonaws.com\"\n      }\n    }]\n  })\n}\n\nresource \"aws_iam_policy\" \"route53_logging_policy\" {\n  name = \"route53-query-logging-policy\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Effect = \"Allow\"\n      Action = [\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\"\n      ]\n      Resource = [\n        \"arn:aws:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:aws_route53_example_com:*\"\n      ]\n    }]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"route53_logging_attachment\" {\n  role       = aws_iam_role.route53_logging_role.name\n  policy_arn = aws_iam_policy.route53_logging_policy.arn\n}\n\nresource \"aws_cloudwatch_log_group\" \"route53_log_group\" {\n  name              = \"aws_route53_example_com\"\n  retention_in_days = 30\n}\n\nresource \"aws_cloudwatch_log_resource_policy\" \"route53_log_resource_policy\" {\n  policy_name     = \"route53-query-logging-policy\"\n  policy_document = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Effect = \"Allow\"\n      Principal = {\n        Service = \"route53.amazonaws.com\"\n      }\n      Action = [\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\"\n      ]\n      Resource = aws_cloudwatch_log_group.route53_log_group.arn\n    }]\n  })\n}\n\nresource \"aws_route53_zone\" \"primary\" {\n  name = \"example.com\"\n}\n\nresource \"aws_route53_query_log\" \"example\" {\n  cloudwatch_log_group_arn = aws_cloudwatch_log_group.route53_log_group.arn\n  zone_id                  = aws_route53_zone.primary.zone_id\n}\n```",
        "Validation Summary": {
            "status": "failed",
            "syntax_valid": true,
            "cis_compliant": false,
            "referenced_cis_controls": [
                "1.5",
                "1.10",
                "1.16"
            ],
            "issues": [
                "CIS compliance validation failed"
            ],
            "checkov_output_file": "checkov_output/validation_20250415_195035_1480_20250415_195108.json"
        },
        "Compliance Report": "# CIS Compliance Report\n\n## Summary\n- Pass Rate: 85.0%\n- Total Checks: 20\n- Passed: 17\n- Failed: 3\n- Skipped: 0\n\n## CIS Controls Referenced\n- CIS 1.10\n- CIS 1.16\n- CIS 1.5\n\n## Failed Checks\n- CKV_AWS_158: Ensure that CloudWatch Log Group is encrypted by KMS ()\n  - Resource: aws_cloudwatch_log_group.route53_log_group\n  - Guideline: https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-that-cloudwatch-log-group-is-encrypted-by-kms\n- CKV_AWS_338: Ensure CloudWatch log groups retains logs for at least 1 year ()\n  - Resource: aws_cloudwatch_log_group.route53_log_group\n  - Guideline: https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-logging-policies/bc-aws-338\n- CKV2_AWS_38: Ensure Domain Name System Security Extensions (DNSSEC) signing is enabled for Amazon Route 53 public hosted zones ()\n  - Resource: aws_route53_zone.primary\n  - Guideline: https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-networking-policies/bc-aws-2-38",
        "Timestamp": "2025-04-16T01:51:13.948520",
        "Strategy": "chain_of_thought"
    }
]