[
    {
        "Prompt ID": 1,
        "Resource": "aws_cloudwatch_log_group, aws_cloudwatch_log_resource_policy, aws_route53_query_log, aws_route53_zone, aws_iam_policy_document",
        "Prompt": "Configure a query log that can create a log stream and put log events using Route 53 resources. Name the zone \"primary\", the cloudwatch log group \"aws_route53_example_com\", and the cloudwatch log resource policy \"route53-query-logging-policy\"",
        "Rego Intent": "package terraform.validation\n\ndefault is_configuration_valid = false\n\ndefault is_valid_r53_zone = false\n\ndefault is_valid_cloudwatch_log_group = false\n\ndefault is_valid_cloudwatch_log_resource_policy = false\n\ndefault is_valid_route53_query_log = false\n\n# Validate aws_route53_zone resource\nis_valid_r53_zone {\n    some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_zone\"\n    resource.expressions.name\n}\n\nis_valid_cloudwatch_log_group {\n    some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_cloudwatch_log_group\"\n}\n\nis_valid_cloudwatch_log_resource_policy {\n    some i\n    resource := input.resource_changes[i]\n    resource.type == \"aws_cloudwatch_log_resource_policy\"\n    contains(resource.change.after.policy_document, \"logs:PutLogEvents\")\n    contains(resource.change.after.policy_document, \"logs:CreateLogStream\")\n    resource.change.after.policy_name\n}\n\nis_valid_route53_query_log {\n    some i\n    resource := input.configuration.root_module.resources[i]\n    resource.type == \"aws_route53_query_log\"\n    resource.expressions.zone_id.references[0] == \"aws_route53_zone.primary.zone_id\"\n    resource.expressions.cloudwatch_log_group_arn.references[0] == \"aws_cloudwatch_log_group.aws_route53_example_com.arn\"\n    resource.depends_on[0] == \"aws_cloudwatch_log_resource_policy.route53-query-logging-policy\"\n}\n\n# Combine all checks into a final rule\nis_configuration_valid {\n    is_valid_r53_zone\n    is_valid_cloudwatch_log_group\n    is_valid_cloudwatch_log_resource_policy\n    is_valid_route53_query_log\n}",
        "Difficulty": 5,
        "Reference Output": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.75\"\n    }\n  }\n\n  required_version = \"~> 1.9.8\"\n}\n\nprovider \"aws\" {\n  region  = \"us-east-1\"\n  profile = \"admin-1\"\n\n  assume_role {\n    role_arn = \"arn:aws:iam::590184057477:role/yicun-iac\"\n  }\n}\n\n\nresource \"aws_route53_zone\" \"primary\" {\n  name = \"example53.com\"\n}\n\nresource \"aws_cloudwatch_log_group\" \"aws_route53_example_com\" {\n  name              = \"/aws/route53/${aws_route53_zone.primary.name}\"\n  retention_in_days = 30\n}\n\n# Example CloudWatch log resource policy to allow Route53 to write logs\n# to any log group under /aws/route53/*\n\ndata \"aws_iam_policy_document\" \"route53-query-logging-policy\" {\n  statement {\n    actions = [\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\",\n    ]\n\n    resources = [\"arn:aws:logs:*:*:log-group:/aws/route53/*\"]\n\n    principals {\n      identifiers = [\"route53.amazonaws.com\"]\n      type        = \"Service\"\n    }\n  }\n}\n\nresource \"aws_cloudwatch_log_resource_policy\" \"route53-query-logging-policy\" {\n  policy_document = data.aws_iam_policy_document.route53-query-logging-policy.json\n  policy_name     = \"route53-query-logging-policy\"\n}\n\nresource \"aws_route53_query_log\" \"example_com\" {\n  depends_on = [aws_cloudwatch_log_resource_policy.route53-query-logging-policy]\n\n  cloudwatch_log_group_arn = aws_cloudwatch_log_group.aws_route53_example_com.arn\n  zone_id                  = aws_route53_zone.primary.zone_id\n}",
        "Intent": "Has one \"aws_route53_zone\" resource\n    with \"name\"\n\nHas one \"aws_cloudwatch_log_group\" resource\n\nHas one \"aws_cloudwatch_log_resource_policy\" resource\n    with \"policy_document\" enabling \"logs:CreateLogStream\" and \"logs:PutLogEvents\"\n    with \"policy_name\"\n\nHas one \"aws_route53_query_log\" resource\n    with \"cloudwatch_log_group_arn\" referencing the \"aws_cloudwatch_log_group\" resource\n    with \"zone_id\" referencing the \"aws_route53_zone\" resource\n    and depends on the \"aws_cloudwatch_log_resource_policy\" resource",
        "Generated Code": "```hcl\n```hcl\nprovider \"aws\" {\n  region = \"us-west-2\"\n}\n\ndata \"aws_caller_identity\" \"current\" {}\n\nresource \"aws_iam_role\" \"example\" {\n  name               = \"query-log-sgr\"\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"route53.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      },\n      {\n        Effect = \"Allow\"\n        Principal = {\n          Service = \"s3.amazonaws.com\"\n        }\n        Action = \"sts:AssumeRole\"\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy\" \"example\" {\n  name = \"query-log-policy\"\n\n  role = aws_iam_role.example.id\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect = \"Allow\"\n        Action = [\n          \"s3:PutObject\",\n          \"s3:GetObject\"\n        ]\n        Resource = [\n          \"arn:aws:s3:::my-bucket/*\"\n        ]\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"example\" {\n  role      = aws_iam_role.example.name\n  policy_arn = aws_iam_role_policy.example.arn\n}\n\nresource \"aws_route53_zone\" \"primary\" {\n  name                  = \"example.com\"\n  vpc                  = aws_vpc.vpc.id\n  tags                 = {\n    Name      = \"zone_primary\"\n    Environment = \"Production\"\n  }\n}\n\ndata \"aws_route53_zone\" \"vpc_zone\" {\n  name    = aws_iam_role.example.name\n}\n\ndata \"aws_caller_identity\" \"current\" {\n}\n\nresource \"aws_cloudwatch_log_group\" \"aws_route53_example_com\" {\n  name = data.aws_route53_zone.vpc_zone.name\n}\n\nresource \"aws_cloudwatch_log_resource_policy\" \"route53-query-logging-policy\" {\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect    = \"Allow\"\n        Principal = {\n          Service = \"route53.amazonaws.com\"\n        }\n        Action    = \"s3:PutObject\"\n        Resource  = \"arn:aws:s3:::my-bucket/*\"\n      }\n    ]\n  })\n}\n```",
        "Validation Summary": {
            "status": "failed",
            "syntax_valid": false,
            "cis_compliant": false,
            "referenced_cis_controls": [],
            "issues": [
                "Terraform syntax validation failed",
                "CIS compliance validation failed",
                "No Terraform code provided"
            ],
            "checkov_output_file": ""
        },
        "Compliance Report": "",
        "Timestamp": "2025-04-16T01:55:03.331960",
        "Strategy": "few_shot"
    }
]